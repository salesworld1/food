<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Запись волонтёра</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280;
  --accent:#16a34a; --ok-bg:#dcfce7; --ok:#166534; --err-bg:#fee2e2; --err:#991b1b; --border:#e5e7eb;
}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{display:flex;justify-content:center;padding:16px}
.card{max-width:720px;width:100%;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:20px 18px}
h1{margin:0 0 12px;font-size:20px}
.field{margin-top:12px}
label{display:block;margin-bottom:6px;color:#334155}
select,textarea,button,input[type=checkbox]{font-size:16px}
select,textarea{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:12px;padding:12px 44px 12px 12px;background:#fff;min-height:48px}
textarea{min-height:96px;resize:vertical}
.inline{display:flex;align-items:center;gap:10px;margin-top:10px}
.btn{display:inline-flex;align-items:center;justify-content:center;height:48px;padding:0 16px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.notice{margin-top:10px;padding:12px;border-radius:12px;font-weight:600;border:1px solid #bbf7d0;background:var(--ok-bg);color:var(--ok)}
.notice.err{background:var(--err-bg);color:var(--err);border-color:#fecaca}
.toast-wrap{position:fixed;left:0;right:0;top:12px;display:flex;justify-content:center;pointer-events:none}
.toast{pointer-events:auto;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:12px 14px;font-weight:600;opacity:0;transform:translateY(-12px);transition:.18s}
.toast.show{opacity:1;transform:none}
.toast.err{background:var(--err-bg);color:var(--err);border-color:#fecaca}
.hint{color:var(--muted);font-size:14px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Запись волонтёра</h1>

    <div class="field">
      <label for="name">Ваше имя</label>
      <select id="name"></select>
    </div>

    <div class="field">
      <label for="role">Роль</label>
      <select id="role"></select>
    </div>

    <div class="field">
      <label for="date">Дата</label>
      <select id="date"></select>
      <div id="hintDates" class="hint" style="display:none">Нет доступных дат. Свяжитесь с координатором.</div>
    </div>

    <div class="field">
      <label for="comment">Комментарий <span class="hint">(необязательно)</span></label>
      <textarea id="comment" placeholder="Например: приду на 30 мин раньше; могу взять хлеб."></textarea>
    </div>

    <div class="inline">
      <input type="checkbox" id="notify"/>
      <label for="notify" style="margin:0">Хочу получать уведомления в Telegram</label>
    </div>

    <div id="tgBlock" class="field" style="display:none">
      <button id="btnBot" class="btn" style="background:#1476ff">Подключить напоминания в Telegram</button>
      <div id="botState" class="hint"></div>
    </div>

    <div class="field">
      <button id="btnSave" class="btn"><span id="btnSaveTxt">Записаться</span></button>
      <div id="inlineNotice" class="notice" role="status" aria-live="polite" style="display:none"></div>
    </div>
  </div>
</div>

<div class="toast-wrap"><div id="toast" class="toast"><span id="toastText"></span></div></div>

<script>
// ==== ЗАПОЛНИТЬ ПЕРЕД ДЕПЛОЕМ ====
const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycbzSK4yKGfPDo2QiCJYvg0PJGfpK69jcflgdHM7KkUhruSyLh-wE9_9mrtRCj0Gknx6j6Q/exec';
const GAS_KEY      = 'F4Lsmolensk_9f3b2c1d7a6e41ab';   // тот же, что KEY_TELEGRAM_WEBHOOK в Script Properties
const BOT_LINK     = 'https://t.me/food4life_smolensk_bot'; // резерв (если сервер не вернёт свой)

// ==== DOM
const $=id=>document.getElementById(id);
const nameEl=$('name'), roleEl=$('role'), dateEl=$('date'), comEl=$('comment');
const chkEl=$('notify'), btnSave=$('btnSave'), btnSaveTxt=$('btnSaveTxt');
const tgBlock=$('tgBlock'), btnBot=$('btnBot'), botState=$('botState');
const inlineNotice=$('inlineNotice'), hintDates=$('hintDates');
const toast=$('toast'), toastText=$('toastText');

const b64url = s => btoa(unescape(encodeURIComponent(s))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const setBusy = b => { btnSave.disabled=b; btnSaveTxt.textContent = b ? 'Записываем…' : 'Записаться'; };
const showToast=(t,err=false)=>{ toastText.textContent=t||''; toast.className='toast'+(err?' err':''); toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 3500); };
const showInline=(t,ok=true)=>{ inlineNotice.textContent=t||''; inlineNotice.className='notice'+(ok?'':' err'); inlineNotice.style.display='block'; inlineNotice.scrollIntoView({behavior:'smooth',block:'center'}); };

async function api(cmd, data){
  const url = GAS_EXEC_URL + '?api=' + cmd + (GAS_KEY?('&k='+encodeURIComponent(GAS_KEY)):'');
  if (cmd==='getInit'){
    const r = await fetch(url, {method:'GET'});
    return r.json();
  }
  if (cmd==='book'){
    const r = await fetch(url, {method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(data||{})});
    return r.json();
  }
}

function fillOptions(sel, list){
  sel.innerHTML = '<option value="">— выберите —</option>' + (list||[]).map(v=>`<option>${String(v||'')}</option>`).join('');
}
function fillDates(sel, dates){
  sel.innerHTML = '<option value="">— выберите —</option>';
  if (!dates || !dates.length){ hintDates.style.display='block'; sel.disabled=true; return; }
  hintDates.style.display='none'; sel.disabled=false;
  const groups={}, months=['январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь'];
  dates.forEach(d=>{ const [dd,mm,yyyy]=String(d.label).split('.'); const key=months[+mm-1]+' '+yyyy; (groups[key]=groups[key]||[]).push(d); });
  Object.keys(groups).forEach(g=>{
    const og=document.createElement('optgroup'); og.label=g;
    groups[g].forEach(d=>{ const o=document.createElement('option'); o.value=d.col; o.textContent=d.label; og.appendChild(o); });
    sel.appendChild(og);
  });
}

// init
(async function(){
  try{
    const d = await api('getInit');
    if (!d || !d.ok) throw 0;
    fillOptions(nameEl, d.names||[]);
    fillOptions(roleEl, d.roles||[]);
    fillDates(dateEl, d.dates||[]);
    window.__BOT__ = (d.botLink && /^https?:\/\/t\.me\//.test(d.botLink)) ? d.botLink : BOT_LINK;
  }catch(_){
    showToast('Не удалось загрузить данные формы.', true);
    btnSave.disabled = true;
  }
})();

function updateTgUi(){
  const need = !!(chkEl.checked && (nameEl.value||'').trim());
  tgBlock.style.display = need ? '' : 'none';
}
nameEl.addEventListener('change', updateTgUi);
chkEl.addEventListener('change', updateTgUi);

btnBot.addEventListener('click', ()=>{
  const name=(nameEl.value||'').trim(); if(!name) return;
  window.open((window.__BOT__||BOT_LINK)+'?start=b64_'+b64url(name), '_blank', 'noopener');
  botState.textContent='Открылся Telegram. Нажмите «Start».';
});

btnSave.addEventListener('click', async ()=>{
  inlineNotice.style.display='none';
  const payload={
    name:(nameEl.value||'').trim(),
    role:(roleEl.value||'').trim(),
    dateCol:Number(dateEl.value||0),
    comment:(comEl.value||'').trim(),
    notify:!!chkEl.checked
  };
  if(!payload.name || !payload.role || !payload.dateCol){ showToast('Пожалуйста, выберите имя, роль и дату.', true); return; }
  setBusy(true);
  try{
    const res = await api('book', payload);
    setBusy(false);
    if(res && res.ok){ showInline(res.msg || 'Готово!', true); } else { showToast(res?.msg || 'Ошибка.', true); }
  }catch(e){
    setBusy(false);
    showToast('Не удалось записаться. Попробуйте позже.', true);
  }
});
</script>
</body>
</html>
